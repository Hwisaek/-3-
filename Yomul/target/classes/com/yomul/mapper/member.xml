<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.member">
	<insert id="join" parameterType="com.yomul.vo.MemberVO">
		INSERT INTO YOMUL_MEMBERS(NO, EMAIL, PW, NICKNAME, HASHSALT, SUBSCRIBE) 
		VALUES('M'||YOMUL_MEMBERS_NO_SEQ.NEXTVAL, #{email}, #{pw}, #{nickname}, #{hashsalt}, #{subscribe})
	</insert>
	
	<select id="getmyprofileinfo" parameterType="com.yomul.vo.MemberVO" resultType="com.yomul.vo.MemberVO">
		SELECT EMAIL, NICKNAME, PHONE, GENDER, INTRO, F.FILENAME FILENAME 
		FROM YOMUL_MEMBERS M LEFT JOIN YOMUL_FILES F ON M.NO = F.ARTICLE_NO 
		WHERE M.NO = #{no}
	</select>
	
	<insert id="setmyprofileinfo" parameterType="com.yomul.vo.MemberVO">
		UPDATE YOMUL_MEMBERS SET NICKNAME = #{nickname}, PHONE = #{phone}, GENDER = #{gender}, INTRO = #{intro} WHERE NO = #{no}
	</insert>
	
	<update id="setmyprofileimg" parameterType="com.yomul.vo.MemberVO">
		MERGE INTO YOMUL_FILES USING DUAL ON (ARTICLE_NO = #{no})
			WHEN MATCHED THEN
				UPDATE SET FILENAME = #{profileImg} WHERE ARTICLE_NO = #{no}
			WHEN NOT MATCHED THEN
				INSERT (ARTICLE_NO, NO, FILENAME) VALUES(#{no}, YOMUL_FILES_NO_SEQ.NEXTVAL, #{profileImg}) 
	</update>
	
	<select id="getbuycount" parameterType="com.yomul.vo.MemberVO" resultType="int">
		SELECT COUNT(*) 
		FROM YOMUL_TRADE_HISTORY 
		WHERE BUYER = #{no}
	</select>
	
	<select id="getsellcount" parameterType="com.yomul.vo.MemberVO" resultType="int">
		SELECT COUNT(*) 
		FROM YOMUL_TRADE_HISTORY
		 WHERE SELLER = #{no}
	</select>
	
	<select id="getfavoritecount" parameterType="com.yomul.vo.MemberVO" resultType="int">
		SELECT COUNT(*) 
		FROM YOMUL_FAVORITE_LISTS 
		WHERE MEMBER_NO = #{no}
	</select>
	
	<select id="emailcheck" parameterType="string" resultType="int">
		SELECT COUNT(EMAIL) 
		FROM YOMUL_MEMBERS 
		WHERE LOWER(EMAIL) = LOWER(#{email})
	</select>
	
	<select id="nicknamecheck" parameterType="string" resultType="int">
		SELECT COUNT(NICKNAME) 
		FROM YOMUL_MEMBERS 
		WHERE LOWER(NICKNAME) = LOWER(#{nickname})
	</select>
</mapper>